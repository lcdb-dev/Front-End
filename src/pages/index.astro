---
import BaseLayout from "../layouts/BaseLayout.astro";
import Header from "../components/Header.astro";
import ArticleSlider from "../components/ArticleSlider.astro";
import MainContent from "../components/MainContent.astro";
import RandomArticles from "../components/RandomArticles.astro";
import RecipesSections from "../components/RecipesSections.astro";
import VideoSection from "../components/VideoSection.astro";
import GlobalAbout from "../components/GlobalAbout.astro";
import GlobalFooter from "../components/GlobalFooter.astro";
import { getArticlesPage as getArticlesPagePayload } from "../lib/payload.client";
import { getAllArticlesFromMongo } from "../lib/mongo.server";
// Enable SSG with ISR for homepage
export const prerender = true;

// Static homepage - show first page only for SSG
const currentPage = 1; // Always show page 1 for SSG
const articlesPerPage = 10;
const getBuildLimit = () => {
  const envLimit = Number(process.env.MAX_SSG_ARTICLES);
  return Number.isFinite(envLimit) && envLimit > 0 ? envLimit : 50;
};

// Build-time article source should match static detail route generation.
let allBuildArticles = await getAllArticlesFromMongo();

// If MongoDB fails, fall back to Payload
if (!allBuildArticles || allBuildArticles.length === 0) {
  const payloadResponse: any = await getArticlesPagePayload(currentPage, getBuildLimit());
  allBuildArticles = Array.isArray(payloadResponse) ? payloadResponse : [];
}

const articles = allBuildArticles.slice(0, articlesPerPage);
const totalPages = Math.max(1, Math.ceil(allBuildArticles.length / articlesPerPage));

// Helper functions
const decodeHtmlEntities = (text: string) => {
  const entities: { [key: string]: string } = {
    '&nbsp;': ' ',
    '&amp;': '&',
    '&lt;': '<',
    '&gt;': '>',
    '&quot;': '"',
    '&#39;': "'",
    '&hellip;': '…',
    '&mdash;': '—',
    '&ndash;': '–',
    '&lsquo;': "'",
    '&rsquo;': "'",
    '&ldquo;': '"',
    '&rdquo;': '"',
    '&bull;': '•',
    '&deg;': '°',
    '&frac12;': '½',
    '&frac14;': '¼',
    '&frac34;': '¾',
  };

  return text.replace(/&[a-zA-Z0-9#]+;/g, (entity) => {
    return entities[entity] || entity;
  });
};

const stripHtml = (html: string) => {
  if (!html) return '';
  const text = html.replace(/<[^>]*>/g, '');
  const decodedText = decodeHtmlEntities(text);
  return decodedText.substring(0, 150) + (decodedText.length > 150 ? '...' : '');
};

const getExcerpt = (article: any) => {
  if (article.excerpt && Array.isArray(article.excerpt)) {
    const text = article.excerpt.map((block: any) => 
      block.children?.map((child: any) => child.text).join(' ') || ''
    ).join(' ');
    return stripHtml(text);
  }
  if (article.content && Array.isArray(article.content)) {
    const text = article.content.map((block: any) => 
      block.children?.map((child: any) => child.text).join(' ') || ''
    ).join(' ');
    return stripHtml(text);
  }
  return '';
};

const formatDate = (dateStr: string) => {
  return new Date(dateStr).toLocaleDateString('en-US', {
    year: 'numeric',
    month: 'short',
    day: 'numeric'
  });
};
---

<BaseLayout title="Home">
  <!-- New Design Header -->
  <!-- <Header currentLang="en" /> -->

  <!-- Article Slider -->
  <ArticleSlider articles={articles} />

  <!-- Main Content (Latest Articles + Sidebar) -->
  <MainContent latestArticles={articles} currentLang="en" currentPage={currentPage} totalPages={totalPages} />

  <!-- Sweet & Savory Recipes Sections -->
  <RecipesSections allArticles={articles} />

  <!-- YouTube Videos Section -->
  <VideoSection />

  <!-- Global About Section -->
  <GlobalAbout />

  <!-- Global Footer -->
  <GlobalFooter />
</BaseLayout>
